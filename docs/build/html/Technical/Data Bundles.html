

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Data Bundles &mdash; CitizenOne 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Contact" href="../Contact.html" />
    <link rel="prev" title="eHealth Splunk Service" href="eHealthSplunkService.html" />
    <link href="../_static/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> CitizenOne
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">The CitizenOne Platform</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Tenants.html">Tenants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Organizations.html">Organizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Service Cards.html">Service Cards</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Rules.html">Rules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Providers.html">Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Policies.html">Policies</a></li>
</ul>
<p class="caption"><span class="caption-text">Eeze</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Eeze.html">Accessing CitizenOne Service Cards</a></li>
</ul>
<p class="caption"><span class="caption-text">Managing CitizenOne</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Management/Tenant Management.html">Tenant Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Organization Management.html">Organization Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Application Management.html">Application Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Service Card Management.html">Service Card Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Rule Management.html">Rule Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Provider Management.html">Trust Provider Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Policy Management.html">Policy Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Creating Service Cards.html">Creating a Service Card</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Platform Configuration.html">Platform Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Management/Layouts.html">Layout Management</a></li>
</ul>
<p class="caption"><span class="caption-text">Technical Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="Authentication.html#multi-factor-authentication">Multi-factor Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="PolicyHierarchy.html">Policy Hierarchy</a></li>
<li class="toctree-l1"><a class="reference internal" href="Federation.html">Federation</a></li>
<li class="toctree-l1"><a class="reference internal" href="MFA Rule Evaluation.html">MFA Rule Evaluation</a></li>
<li class="toctree-l1"><a class="reference internal" href="DynamicIdentityProviders.html">Dynamic Identity Providers</a></li>
<li class="toctree-l1"><a class="reference internal" href="eHealthSplunkService.html">eHealth Splunk Service</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Data Bundles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#lifecycle">Lifecycle</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#scenario-1">Scenario 1</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#bundle-encryption">Bundle Encryption</a></li>
<li class="toctree-l2"><a class="reference internal" href="#data-sent-from-id1">Data Sent from ID1</a></li>
<li class="toctree-l2"><a class="reference internal" href="#receiving-a-bundle">Receiving a Bundle</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">General Information</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../Contact.html">Contact</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">CitizenOne</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>Data Bundles</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/Technical/Data Bundles.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="data-bundles">
<span id="id1"></span><h1>Data Bundles<a class="headerlink" href="#data-bundles" title="Permalink to this headline">¶</a></h1>
<p>Data bundles are an end-to-end encrypted solution for keeping information about a user in sync between different datastores.</p>
<p>A Data Bundle is a block of data with a structure that is defined by
the consumers and providers of said data. The bundles are used to keep
downstream service providers up to date and aware of changes made to
an Identity’s profile without the need for CitizenOne to oversee the
changes themselves.</p>
<p>The example we like to use revolves around an Identity’s banking info.
If an Identity updates their bank data in App A, it can send a banking
data bundle to CitizenOne where the bundle is then sent to any applications
that the Identity has given consent to watch their banking data.</p>
<p>If App B has a policy that also wants baking data, and the Identity has
consented, the bundle will be encrypted using a public key attached to
the policy on App B, where the private key is also owned by App B.
When they receive it, they will then be able to decrypt the Bundle’s <cite>key</cite>, and
<cite>nonce</cite> (a one time code created when encrypting the payload), which can then
be used to decrypt the payload.</p>
<p>This all happens without Identity needing to view the contents of the databundle.</p>
<div class="section" id="lifecycle">
<h2>Lifecycle<a class="headerlink" href="#lifecycle" title="Permalink to this headline">¶</a></h2>
<p>The lifecycle of a data bundle begins with a <a class="reference external" href="http://www.python.org/">Trust Provider</a> which is the creator and owner of a data bundle. A data bundle can be instatiated during one of the two events:</p>
<ol class="arabic simple">
<li><p>A trust provider would like to publish a bundle of data</p></li>
<li><p>A service requesting a data bundle</p></li>
</ol>
<div class="section" id="scenario-1">
<span id="data-bundles-scenario-1"></span><h3>Scenario 1<a class="headerlink" href="#scenario-1" title="Permalink to this headline">¶</a></h3>
<p>A trust provider MUST first ask CitizenOne for the public keys belonging to all of the subscribers of the specific bundleType and identityId. The request to <code class="docutils literal notranslate"><span class="pre">/id1/api/v1/identities/{identityId}/policies/callbacks/{dataBundleType}/publicKeys</span></code> will return:</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;publicKeys&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;policyId&quot;</span><span class="p">:</span> <span class="s2">&quot;A guid to identify this subscriber&quot;</span><span class="p">,</span>
      <span class="nt">&quot;publicKey&quot;</span><span class="p">:</span> <span class="s2">&quot;The subscriber&#39;s publicKey PEM&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The trust provider will loop over the publicKeys array and encrypt the data bundle for each one.</p>
<p>The trust provider will then publish the data bundle by making a <cite>POST</cite> request to <code class="docutils literal notranslate"><span class="pre">/id1/api/v1/identities/{identityId}/dataBundle/{dataBundle}</span></code>. This request specifies <cite>Who</cite> (identityId) the data is about, and <cite>What</cite> (dataBundle) the data is.
The request body MUST be:</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;bundles&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;policyId&quot;</span><span class="p">:</span> <span class="s2">&quot;The guid of matching the publicKey this bundle was encrypted for&quot;</span><span class="p">,</span>
      <span class="nt">&quot;encryptedBundle&quot;</span><span class="p">:</span> <span class="s2">&quot;Base64 standard encoded encrypted json representation of the dataBundle&quot;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Identity-server will iterate over each bundle object and push it on to a RabbitMQ queue. A simple microservice (publish-service) will pop any pending messages from the outgoing message queue, check for consent, and find the destination <cite>url</cite> specified by the subscriber. Finally, publish-service will send the encrypted bundle to the specified url.</p>
<p>The subscriber will then decrypt the data bundle using its RSA private key and unmarshal the json string into an object for use.</p>
</div>
</div>
<div class="section" id="bundle-encryption">
<h2>Bundle Encryption<a class="headerlink" href="#bundle-encryption" title="Permalink to this headline">¶</a></h2>
<p>Due to not always knowing the size of bundles, straight RSA encryption cannot be used.
So, instead, the payload itself is AES-256 encrypted with a randomly generated
key, and then - for each bundle - the <cite>key</cite> and a <cite>nonce</cite> that is created during the AES
encryption are both RSA encrypted using the consumer’s public key. All of the encrypted
values are then Base64 encoded, and added to the message, then published or put back on
a queue.</p>
<p>Data Bundle providers must implement this however they wish on their end.</p>
</div>
<div class="section" id="data-sent-from-id1">
<h2>Data Sent from ID1<a class="headerlink" href="#data-sent-from-id1" title="Permalink to this headline">¶</a></h2>
<p>Not all Data Bundles come from external applications, some come from the
Identity server. Thes bundles are treated slightly differently, so their
Callback type and PolicyId are checked to determine which bundles come from ID1, and which
come from external sources.</p>
<p>PolicyId is set to <cite>nil</cite> when the message from ID1 is ready to be sent out to
consumers, since it is not critical data.</p>
<div class="highlight-Go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="p">(</span><span class="nx">cb</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">CallbackTypeName</span><span class="p">)</span> <span class="o">||</span>
    <span class="nx">cb</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">CallbackTypeAddress</span><span class="p">)</span> <span class="o">||</span>
    <span class="nx">cb</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">CallbackTypeEmail</span><span class="p">)</span> <span class="o">||</span>
    <span class="nx">cb</span> <span class="o">==</span> <span class="nb">string</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">CallbackTypePhone</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">PolicyId</span> <span class="o">==</span> <span class="nx">uuid</span><span class="p">.</span><span class="nx">Nil</span> <span class="p">{</span>
    <span class="o">...</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The different types of ID1 callbacks and events are:</p>
<ul class="simple">
<li><p>model.identity.update, model.email.update, model.phone.update, model.address.update</p></li>
<li><p>model.identity.create, model.email.create, model.phone.create, model.address.create</p></li>
<li><p>model.identity.delete, model.email.delete, model.phone.delete, model.address.delete</p></li>
</ul>
</div>
<p>The main difference between data sent from ID1 versus data sent from a publisher is that
data from ID1 is not yet encrypted, and must be encrypted in the same fashion
that we require of the publishers. After it has been encrypted, the message is put
back onto the incoming queue, and will be read and published to the consumers in the same
way that outside messages are sent.</p>
</div>
<div class="section" id="receiving-a-bundle">
<h2>Receiving a Bundle<a class="headerlink" href="#receiving-a-bundle" title="Permalink to this headline">¶</a></h2>
<p>In the interest of making decryption as easy as possible for consumers, a <cite>DecryptPayload</cite>
method has been made available through the Vivvo <cite>go-sdk</cite>. It would be possible to decrypt
in other languages, but as of now, our only officially supported language is Golang.</p>
<p>The consumer will simply receive a post request with a body of type <cite>PublishWrapperDto</cite> to the endpoint specified in the Policy,
and can then decrypt the payload into whatever structure they are expecting. An example of this
is shown below.</p>
<div class="highlight-Go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">db</span> <span class="nx">models</span><span class="p">.</span><span class="nx">PublishWrapperDto</span>
<span class="nx">utils</span><span class="p">.</span><span class="nx">ReadBody</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">db</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span> <span class="c1">// Reads the body of the request into a PublishWrapperDto variable</span>

<span class="kd">var</span> <span class="nx">address</span> <span class="nx">models</span><span class="p">.</span><span class="nx">Address</span> <span class="c1">// The expected type of bundle</span>
<span class="nx">err</span> <span class="o">:=</span> <span class="nx">trustprovider</span><span class="p">.</span><span class="nx">DecryptPayload</span><span class="p">(</span><span class="nx">db</span><span class="p">,</span> <span class="nx">privateKey</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">address</span><span class="p">)</span> <span class="c1">// Pass in the full request body, with the private key and destination object</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Contact.html" class="btn btn-neutral float-right" title="Contact" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="eHealthSplunkService.html" class="btn btn-neutral float-left" title="eHealth Splunk Service" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Vivvo

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>